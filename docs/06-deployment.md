# Deployment - Deploy-áƒ˜áƒ¡ áƒ’áƒáƒ˜áƒ“áƒ˜

> ğŸš€ **Production deployment Railway-áƒ–áƒ” áƒ“áƒ domain áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ**

---

## ğŸ“‹ áƒ¡áƒáƒ áƒ©áƒ”áƒ•áƒ˜

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Railway Setup](#railway-setup)
3. [Environment Variables](#environment-variables)
4. [Database Migration](#database-migration)
5. [Domain Configuration](#domain-configuration)
6. [CI/CD Pipeline](#cicd-pipeline)
7. [Monitoring & Logging](#monitoring--logging)
8. [Troubleshooting](#troubleshooting)

---

## Pre-Deployment Checklist

### áƒ™áƒáƒ“áƒ˜áƒ¡ áƒ›áƒ–áƒáƒ“áƒáƒ‘áƒ

```bash
â–¡ áƒ§áƒ•áƒ”áƒšáƒ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒšáƒáƒ™áƒáƒšáƒ£áƒ áƒáƒ“
â–¡ No console.logs left in production code
â–¡ Environment variables áƒ“áƒáƒ™áƒ£áƒ›áƒ”áƒœáƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ
â–¡ Database migrations áƒ›áƒ–áƒáƒ“áƒáƒ
â–¡ Tests áƒ’áƒáƒ“áƒ˜áƒ¡
â–¡ Build works locally: pnpm build
â–¡ No TypeScript errors: pnpm type-check
â–¡ Linting clean: pnpm lint
```

### Security Checklist

```bash
â–¡ NEXTAUTH_SECRET generated (openssl rand -base64 32)
â–¡ All sensitive data in environment variables
â–¡ No hardcoded API keys in code
â–¡ CORS configured properly
â–¡ Rate limiting enabled
â–¡ SQL injection protection verified
```

### Performance Checklist

```bash
â–¡ Images optimized
â–¡ Caching strategy implemented
â–¡ Database indexes added
â–¡ Bundle size acceptable (check pnpm build output)
```

---

## Railway Setup

### 1. Create Railway Account

```
https://railway.app
â†’ Sign up with GitHub
```

### 2. Install Railway CLI (Optional)

```bash
# macOS
brew install railway

# npm
npm install -g @railway/cli

# Login
railway login
```

### 3. Create New Project

**Via Web Dashboard:**

```
Dashboard â†’ New Project â†’ Deploy from GitHub repo
â†’ Select your repository
â†’ Select branch: main
```

**Via CLI:**

```bash
cd qr-menu
railway init
railway link
```

### 4. Add PostgreSQL Database

```
Project â†’ New â†’ Database â†’ Add PostgreSQL

Railway will automatically:
- Create a PostgreSQL instance
- Generate DATABASE_URL
- Add it to environment variables
```

### 5. Add Redis (Upstash)

```
Project â†’ Variables â†’ Add Variable

Add Upstash credentials:
- UPSTASH_REDIS_REST_URL
- UPSTASH_REDIS_REST_TOKEN
```

---

## Environment Variables

### Railway Environment Variables

```
Project â†’ Variables â†’ Raw Editor
```

áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’áƒ˜ áƒªáƒ•áƒšáƒáƒ“áƒ”áƒ‘áƒ˜:

```bash
# ===================================
# APPLICATION
# ===================================
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://digitalmenu.ge

# ===================================
# DATABASE (Auto-generated by Railway)
# ===================================
DATABASE_URL=postgresql://...

# ===================================
# AUTHENTICATION
# ===================================
NEXTAUTH_URL=https://digitalmenu.ge
NEXTAUTH_SECRET=<generate-with-openssl-rand-base64-32>

# Google OAuth
GOOGLE_CLIENT_ID=xxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxx

# ===================================
# FILE STORAGE (Cloudflare R2)
# ===================================
R2_ACCOUNT_ID=your-account-id
R2_ACCESS_KEY_ID=your-access-key
R2_SECRET_ACCESS_KEY=your-secret-key
R2_BUCKET_NAME=digital-menu-uploads
R2_PUBLIC_URL=https://cdn.digitalmenu.ge

# ===================================
# CACHING (Upstash Redis)
# ===================================
UPSTASH_REDIS_REST_URL=https://your-endpoint.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-token

# ===================================
# REAL-TIME (Pusher)
# ===================================
PUSHER_APP_ID=123456
PUSHER_SECRET=your-secret
PUSHER_CLUSTER=eu

# Public (accessible on client)
NEXT_PUBLIC_PUSHER_KEY=your-public-key
NEXT_PUBLIC_PUSHER_CLUSTER=eu

# ===================================
# EMAIL (Resend)
# ===================================
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@digitalmenu.ge

# ===================================
# PAYMENTS (BOG iPay) - Phase 3
# ===================================
BOG_API_KEY=your-bog-api-key
BOG_MERCHANT_ID=your-merchant-id
BOG_CALLBACK_URL=https://digitalmenu.ge/api/payments/callback
```

### Generate NEXTAUTH_SECRET

```bash
openssl rand -base64 32
```

### Variable Groups (Optional)

```
Production  # digitalmenu.ge
Staging     # staging.digitalmenu.ge
```

---

## Database Migration

### Option 1: Prisma Migrate (Recommended)

```bash
# Local terminal (connected to Railway DB)
DATABASE_URL="postgresql://..." pnpm prisma migrate deploy

# Or via Railway CLI
railway run pnpm prisma migrate deploy
```

### Option 2: Prisma Push (Quick)

```bash
# Push schema without migrations
railway run pnpm prisma db push
```

### Seed Production Data (Optional)

```bash
railway run pnpm db:seed
```

### Verify Database

```bash
# Open Prisma Studio pointing to Railway DB
DATABASE_URL="postgresql://..." pnpm db:studio
```

---

## Domain Configuration

### 1. Purchase Domain

```
Recommended registrars:
- Namecheap
- Google Domains
- Cloudflare Registrar

Example: digitalmenu.ge
```

### 2. Add Domain to Railway

```
Project â†’ Settings â†’ Domains

Add Custom Domain: digitalmenu.ge
```

Railway will provide:

```
CNAME record:
digitalmenu.ge â†’ <your-app>.railway.app
```

### 3. Configure DNS

**At your registrar (e.g., Namecheap):**

```
Type   Name   Value                              TTL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CNAME  @      <your-app>.railway.app             Auto
CNAME  www    <your-app>.railway.app             Auto
```

**For Cloudflare R2 (CDN):**

```
Type   Name   Value                              TTL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CNAME  cdn    <your-bucket>.r2.cloudflarestorage.com  Auto
```

### 4. SSL Certificate

Railway automatically provisions SSL certificates via Let's Encrypt.

Wait ~5-10 minutes after DNS configuration.

### 5. Verify

```bash
# Check DNS propagation
dig digitalmenu.ge
nslookup digitalmenu.ge

# Test HTTPS
curl -I https://digitalmenu.ge
```

### 6. Update Google OAuth

```
Google Cloud Console â†’ Credentials â†’ Edit OAuth Client

Authorized JavaScript origins:
+ https://digitalmenu.ge

Authorized redirect URIs:
+ https://digitalmenu.ge/api/auth/callback/google
```

---

## CI/CD Pipeline

### GitHub Actions Setup

#### Create Workflow File

```yaml
# .github/workflows/deploy.yml

name: Deploy to Railway

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Run tests
        run: pnpm test

      - name: Build
        run: pnpm build

  deploy:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: "digital-menu"
```

#### Add Railway Token to GitHub Secrets

```
1. Railway Dashboard â†’ Account Settings â†’ Tokens
   â†’ Create New Token â†’ Copy

2. GitHub â†’ Repository â†’ Settings â†’ Secrets and Variables â†’ Actions
   â†’ New repository secret
   Name: RAILWAY_TOKEN
   Value: <paste-token>
```

### Auto-Deploy on Push

Railway automatically deploys on push to `main` branch.

```bash
git push origin main
# Railway detects push and triggers deployment
```

### Deployment Logs

```
Railway Dashboard â†’ Deployments â†’ View Logs

or

railway logs
```

---

## Monitoring & Logging

### Railway Built-in Monitoring

```
Dashboard â†’ Metrics

View:
- CPU usage
- Memory usage
- Network traffic
- Request count
- Response times
```

### Application Logs

```bash
# View logs via CLI
railway logs

# View logs in dashboard
Dashboard â†’ Deployments â†’ Logs
```

### Custom Logging (Optional - Sentry)

```bash
pnpm add @sentry/nextjs
```

```typescript
// sentry.client.config.ts
import * as Sentry from "@sentry/nextjs"

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1
})
```

### Health Check Endpoint

```typescript
// app/api/health/route.ts

import { NextResponse } from "next/server"
import { prisma } from "@repo/database"
import { redis } from "@/lib/cache/redis"

export async function GET() {
  try {
    // Check database
    await prisma.$queryRaw`SELECT 1`

    // Check Redis
    await redis.ping()

    return NextResponse.json({
      status: "healthy",
      timestamp: new Date().toISOString(),
      services: {
        database: "ok",
        redis: "ok"
      }
    })
  } catch (error) {
    return NextResponse.json(
      {
        status: "unhealthy",
        error: error.message
      },
      { status: 503 }
    )
  }
}
```

### Uptime Monitoring (Optional)

```
Services:
- UptimeRobot (free)
- Pingdom
- StatusCake

Monitor: https://digitalmenu.ge/api/health
Interval: 5 minutes
```

---

## Troubleshooting

### Common Issues

#### Issue: Build Fails

```bash
Error: Build failed

Troubleshooting:
1. Check Railway build logs
2. Verify all environment variables are set
3. Test build locally: pnpm build
4. Check for missing dependencies in package.json
```

#### Issue: Database Connection Failed

```bash
Error: Can't reach database server

Fix:
1. Verify DATABASE_URL is set in Railway variables
2. Check if Railway PostgreSQL service is running
3. Ensure Prisma client is generated: pnpm prisma generate
4. Run migrations: railway run pnpm prisma migrate deploy
```

#### Issue: Application Crashes on Startup

```bash
Error: Application exited with code 1

Troubleshooting:
1. Check Railway logs: railway logs
2. Verify all required environment variables are set
3. Check for syntax errors
4. Verify dependencies are installed
```

#### Issue: Domain Not Working

```bash
Error: DNS_PROBE_FINISHED_NXDOMAIN

Fix:
1. Verify DNS records are correct
2. Wait for DNS propagation (up to 48 hours)
3. Check with: dig digitalmenu.ge
4. Clear browser cache
```

#### Issue: OAuth Not Working

```bash
Error: redirect_uri_mismatch

Fix:
1. Update Google OAuth credentials
2. Add production URL to authorized redirect URIs
3. Ensure NEXTAUTH_URL is set correctly
```

#### Issue: Images Not Loading

```bash
Error: 403 Forbidden from R2

Fix:
1. Verify R2_PUBLIC_URL is correct
2. Check R2 bucket permissions (public read)
3. Verify CORS configuration on R2 bucket
4. Check R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY
```

### Debug Mode

```bash
# Enable debug logging in Railway
NODE_ENV=production
DEBUG=* # Enable all debug logs (temporarily)
```

### Rollback Deployment

```
Railway Dashboard â†’ Deployments â†’ Select previous deployment â†’ Redeploy
```

---

## Post-Deployment Checklist

### Verification

```bash
â–¡ Site loads: https://digitalmenu.ge
â–¡ HTTPS working (green padlock)
â–¡ Can register new account
â–¡ Can login
â–¡ Can create menu
â–¡ Can upload image
â–¡ Can generate QR code
â–¡ Public menu works: /m/[slug]
â–¡ Real-time updates work
â–¡ Google OAuth works
â–¡ All environment variables correct
â–¡ Health check passes: /api/health
```

### Performance

```bash
â–¡ Lighthouse score > 90
â–¡ Core Web Vitals "Good"
â–¡ Images loading fast
â–¡ No console errors
```

### Security

```bash
â–¡ HTTPS enforced
â–¡ No exposed secrets
â–¡ Rate limiting active
â–¡ CORS configured properly
```

---

## Scaling (Future)

### Railway Autoscaling

```
Currently: Single instance

For scaling:
1. Railway Pro plan
2. Enable autoscaling
3. Configure min/max instances
4. Set up load balancer
```

### Database Scaling

```
Neon offers:
- Auto-scaling compute
- Branching for development
- Connection pooling

For heavy traffic:
- Enable Neon's connection pooler
- Increase compute units
```

### CDN (Optional)

```
Cloudflare CDN in front of Railway:
1. Add domain to Cloudflare
2. Enable Cloudflare proxy (orange cloud)
3. Cache static assets
4. DDoS protection
```

---

## Backup Strategy

### Database Backups

```
Neon provides:
- Automatic daily backups (7 days retention)
- Point-in-time restore

Manual backup:
railway run pg_dump $DATABASE_URL > backup.sql
```

### File Backups (R2)

```
Cloudflare R2:
- Automatic replication
- Versioning available
- S3-compatible backup tools
```

---

## Cost Estimate

| Service | Plan | Monthly Cost |
|---------|------|--------------|
| **Railway** | Hobby ($5) + Usage | ~$10-20 |
| **Neon DB** | Free (0.5GB) | $0 (or $19 Pro) |
| **Upstash Redis** | Free (10k cmds/day) | $0 (or $10+ paid) |
| **Cloudflare R2** | Free (10GB) | $0 (or $0.015/GB) |
| **Pusher** | Free (200k msg/day) | $0 (or $49+ paid) |
| **Resend** | Free (3k emails/mo) | $0 (or $20+ paid) |
| **Domain** | Annual | ~$10/year |
| **Total** | Estimated | **~$10-30/month** |

**Note:** Costs increase with usage. Monitor Railway usage dashboard.

---

## Success! ğŸ‰

áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒáƒšáƒ˜áƒ™áƒáƒªáƒ˜áƒ áƒáƒ®áƒšáƒ live-áƒ–áƒ”áƒ!

**Next Steps:**
- ğŸ“Š Monitor logs and metrics
- ğŸ› Fix any production bugs
- ğŸ“ˆ Track user feedback
- ğŸš€ Iterate and improve

---

**áƒ‘áƒáƒšáƒ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ:** 2026-01-26
